<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <meta name="robots" content="index, follow">
    <meta name="geo.region" content="ES-CT">
    <meta name="geo.placename" content="Barcelona, Sitges, Costa Brava">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/673f7444d1dcca5c5b6d6d2a/d1ec5307-a73b-4044-8141-c80b2c67bf66/VERV+ONE+FAVICON+%281%29.png?content-type=image%2Fpng">
    
    <!-- Font Loading -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
    
    <!-- Dynamic SEO Meta Tags -->
    <title id="pageTitle">Properties | VERV ONE</title>
    <meta name="description" id="pageDescription" content="Browse our exclusive collection of luxury properties in Barcelona, Sitges, and Costa Brava.">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-09NW5Z6Y0S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-09NW5Z6Y0S');
    </script>

    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #000;
            background: #fff;
            padding: 0 2rem;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header-nav {
            background: #ffffff;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 0 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            height: 95px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
            margin: 0;
        }

        .nav-link {
            text-decoration: none;
            color: #000;
            font-weight: 500;
            transition: opacity 0.3s ease;
            font-size: 0.95rem;
        }

        .nav-link:hover, .nav-link.active {
            opacity: 0.6;
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #000;
        }

        /* Main Content */
        .main-content {
            margin-top: 140px;
            min-height: 100vh;
        }

        .page-header {
            text-align: center;
            padding: 4rem 0 2rem;
            background: #f8f9fa;
            margin: 0 -2rem 4rem;
        }

        .page-title {
            font-size: 3rem;
            font-weight: 400;
            margin-bottom: 1rem;
            font-family: 'Libre Baskerville', serif;
        }

        .page-subtitle {
            font-size: 1.3rem;
            color: #666;
            font-weight: 300;
            font-style: italic;
        }

        /* Search Form */
        .search-container {
            max-width: 1200px;
            margin: 0 auto 3rem;
            padding: 0 2rem;
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            background: #fff;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .search-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .search-field label {
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }

        .search-field select,
        .search-field input {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.3s ease;
        }

        .search-field select:focus,
        .search-field input:focus {
            outline: none;
            border-color: #000;
        }

        .search-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: end;
        }

        .search-btn:hover {
            background: #333;
        }

        /* Filter Status */
        .filter-status {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 2rem;
            font-family: 'Source Sans 3', sans-serif;
        }

        .filter-status strong {
            color: #000;
        }

        .clear-filter-btn {
            background: #666;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-left: 1rem;
            transition: background 0.3s ease;
        }

        .clear-filter-btn:hover {
            background: #333;
        }

        /* Properties Section */
        .properties-section {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .property-card {
            border: 1px solid #ddd;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .property-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .property-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-family: 'Libre Baskerville', serif;
            color: #000;
        }

        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .property-detail {
            display: flex;
            flex-direction: column;
        }

        .property-detail strong {
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .property-detail span {
            color: #666;
            font-size: 1rem;
        }

        .property-image {
            width: 100%;
            max-width: 400px;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 1rem;
        }

        /* Loading and Error States */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            color: #666;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #666;
        }

        .error-state h3 {
            color: #000;
            margin-bottom: 1rem;
            font-family: 'Libre Baskerville', serif;
        }

        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
            background: white;
            border-radius: 16px;
            margin: 2rem 0;
        }

        .no-results h3 {
            color: #000;
            margin-bottom: 1rem;
            font-family: 'Libre Baskerville', serif;
        }

        /* Footer */
        .footer {
            background: #000;
            color: white;
            padding: 4rem 0 1rem;
            margin: 4rem -2rem 0;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0 1rem;
            }

            .header-nav {
                padding: 0 1rem;
            }

            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                flex-direction: column;
                padding: 1rem;
                gap: 1rem;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }

            .nav-menu.active {
                display: flex;
            }

            .mobile-menu-toggle {
                display: block;
            }

            .logo {
                height: 70px;
            }

            .page-header {
                margin: 0 -1rem 2rem;
                padding: 2rem 0 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .page-subtitle {
                font-size: 1.1rem;
            }

            .search-container {
                padding: 0 1rem;
            }

            .search-form {
                grid-template-columns: 1fr;
                padding: 1.5rem;
            }

            .properties-section {
                padding: 0 1rem;
            }

            .property-details {
                grid-template-columns: 1fr;
            }

            .footer {
                margin: 4rem -1rem 0;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 1.8rem;
            }

            .property-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header-nav">
        <nav class="nav-container">
            <a href="/" class="logo-link">
                <img src="https://raw.githubusercontent.com/riode514/apimo-netlify-api/main/assets/images/verv_one_logo.svg" alt="VERV ONE Logo" class="logo">
            </a>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/about/" class="nav-link">About</a></li>
                <li><a href="/how-we-work/" class="nav-link">How we work</a></li>
                <li><a href="/properties/" class="nav-link active">Properties</a></li>
                <li><a href="/projects/" class="nav-link">Projects</a></li>
                <li><a href="/contact/" class="nav-link">Contact</a></li>
            </ul>
            
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle mobile menu">☰</button>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title" id="pageTitle">Properties</h1>
            <p class="page-subtitle" id="pageSubtitle">Discover exceptional homes in Catalunya's most coveted destinations</p>
        </section>

        <!-- Search Form -->
        <section class="search-container">
            <form class="search-form" id="propertySearchForm">
                <div class="search-field">
                    <label for="location">Location</label>
                    <select name="location" id="location">
                        <option value="">All Locations</option>
                        <option value="Sitges">Sitges</option>
                        <option value="Sant Pere de Ribes">Sant Pere de Ribes</option>
                        <option value="Castelldefels">Castelldefels</option>
                        <option value="Barcelona">Barcelona</option>
                        <option value="Girona">Girona</option>
                        <option value="Costa Brava">Costa Brava</option>
                        <option value="Emporda">Emporda</option>
                        <option value="Cadaqués">Cadaqués</option>
                    </select>
                </div>
                
                <div class="search-field">
                    <label for="type">Property Type</label>
                    <select name="type" id="type">
                        <option value="">All Types</option>
                        <option value="Villa">Villa</option>
                        <option value="Apartment">Apartment</option>
                        <option value="House">House</option>
                        <option value="Penthouse">Penthouse</option>
                        <option value="Townhouse">Townhouse</option>
                    </select>
                </div>
                
                <div class="search-field">
                    <label for="price_min">Min Price (€)</label>
                    <input type="number" name="price_min" id="price_min" placeholder="Min Price" min="0" step="50000">
                </div>
                
                <div class="search-field">
                    <label for="price_max">Max Price (€)</label>
                    <input type="number" name="price_max" id="price_max" placeholder="Max Price" min="0" step="50000">
                </div>
                
                <div class="search-field">
                    <label for="bedrooms">Min Bedrooms</label>
                    <select name="bedrooms" id="bedrooms">
                        <option value="">Any</option>
                        <option value="1">1+</option>
                        <option value="2">2+</option>
                        <option value="3">3+</option>
                        <option value="4">4+</option>
                        <option value="5">5+</option>
                    </select>
                </div>
                
                <button type="submit" class="search-btn">Search Properties</button>
            </form>

            <!-- Filter Status Display -->
            <div id="filterStatus" class="filter-status" style="display: none;">
                <span id="filterStatusText"></span>
                <button id="clearFilterBtn" class="clear-filter-btn" onclick="clearAllFilters()">Clear All Filters</button>
            </div>
        </section>

        <!-- Properties Results -->
        <section id="property-results" class="properties-section">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading properties...</p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 VERV ONE. All rights reserved.</p>
            <p>Signature Estates & Advisory</p>
        </div>
    </footer>

    <!-- JavaScript for Property Search Results -->
    <script>
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🔍 Initializing properties search page...');
            
            // Initialize mobile menu
            initMobileMenu();
            
            // Read URL parameters and load properties
            await initFromUrlParams();
            
            // Initialize search form
            initSearchForm();
            
            console.log('✅ Properties search page initialized');
        });

        // Read URL parameters and load properties
        async function initFromUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const filters = {};
            
            // Read URL parameters
            if (params.get('location')) filters.location = params.get('location');
            if (params.get('type')) filters.type = params.get('type');
            if (params.get('price_min')) filters.price_min = params.get('price_min');
            if (params.get('price_max')) filters.price_max = params.get('price_max');
            if (params.get('bedrooms')) filters.bedrooms = params.get('bedrooms');
            if (params.get('bathrooms')) filters.bathrooms = params.get('bathrooms');
            
            // Update form fields to match URL parameters
            updateFormFromFilters(filters);
            
            // Update page title and subtitle based on filters
            updatePageTitle(filters);
            
            // Load properties with filters
            await loadProperties(filters);
        }

        // Update form fields from filters
        function updateFormFromFilters(filters) {
            if (filters.location) document.getElementById('location').value = filters.location;
            if (filters.type) document.getElementById('type').value = filters.type;
            if (filters.price_min) document.getElementById('price_min').value = filters.price_min;
            if (filters.price_max) document.getElementById('price_max').value = filters.price_max;
            if (filters.bedrooms) document.getElementById('bedrooms').value = filters.bedrooms;
        }

        // Update page title based on filters
        function updatePageTitle(filters) {
            const pageTitle = document.getElementById('pageTitle');
            const pageSubtitle = document.getElementById('pageSubtitle');
            
            if (filters.location) {
                pageTitle.textContent = `Properties in ${filters.location}`;
                pageSubtitle.textContent = `Luxury properties available in ${filters.location}`;
                document.title = `Properties in ${filters.location} | VERV ONE`;
            } else if (Object.keys(filters).length > 0) {
                pageTitle.textContent = 'Filtered Properties';
                pageSubtitle.textContent = 'Properties matching your search criteria';
                document.title = 'Search Results | VERV ONE';
            }
        }

        // Load properties from API
        async function loadProperties(filters = {}) {
            console.log('🏠 Loading properties with filters:', filters);
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                
                if (filters.location && filters.location.trim()) {
                    params.append('location', filters.location.trim());
                }
                
                if (filters.type && filters.type.trim()) {
                    params.append('type', filters.type.trim());
                }
                
                if (filters.price_min) {
                    params.append('price_min', filters.price_min);
                }
                
                if (filters.price_max) {
                    params.append('price_max', filters.price_max);
                }
                
                if (filters.bedrooms) {
                    params.append('bedrooms', filters.bedrooms);
                }
                
                if (filters.bathrooms) {
                    params.append('bathrooms', filters.bathrooms);
                }
                
                // Always get a good number of properties
                params.append('limit', '20');
                
                const apiUrl = `/.netlify/functions/properties${params.toString() ? '?' + params.toString() : ''}`;
                console.log('🔗 API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('✅ API Response:', data);
                
                // Update filter status
                updateFilterStatus(filters, data.count || 0, data.total_before_filter || 0);
                
                // Display properties
                displayProperties(data.properties || []);
                
            } catch (error) {
                console.error('❌ Failed to load properties:', error);
                showError(`Error loading properties: ${error.message}`);
            }
        }

        // Display properties in the results container
        function displayProperties(properties) {
            const container = document.getElementById('property-results');
            container.innerHTML = ''; // Clear loading state
            
            if (!properties || properties.length === 0) {
                showNoResults();
                return;
            }
            
            properties.forEach(property => {
                const card = createPropertyCard(property);
                container.appendChild(card);
            });
        }

        // Create property card element
        function createPropertyCard(property) {
            const card = document.createElement('div');
            card.classList.add('property-card');
            
            // Extract property data with fallbacks
            const title = property.title || 
                         (property.comments && property.comments[0]?.title) || 
                         'Untitled Property';
            
            const location = property.location || 
                           (property.city?.name) || 
                           property.city || 
                           'Location not specified';
            
            const price = formatPrice(property.price);
            
            const bedrooms = property.bedrooms || '-';
            const bathrooms = property.bathrooms || '-';
            
            const builtArea = property.area?.built || property.area?.total || property.surface || '-';
            const landArea = property.land_area || '-';
            
            // Get main image
            let imageUrl = null;
            if (property.photos && property.photos.length > 0) {
                imageUrl = property.photos[0].url || property.photos[0].src || property.photos[0];
            } else if (property.images && property.images.length > 0) {
                imageUrl = property.images[0].url || property.images[0].src || property.images[0];
            } else if (property.photo) {
                imageUrl = property.photo.url || property.photo.src || property.photo;
            }
            
            card.innerHTML = `
                <h3>${title}</h3>
                <div class="property-details">
                    <div class="property-detail">
                        <strong>Location:</strong>
                        <span>${location}</span>
                    </div>
                    <div class="property-detail">
                        <strong>Price:</strong>
                        <span>${price}</span>
                    </div>
                    <div class="property-detail">
                        <strong>Bedrooms:</strong>
                        <span>${bedrooms}</span>
                    </div>
                    <div class="property-detail">
                        <strong>Bathrooms:</strong>
                        <span>${bathrooms}</span>
                    </div>
                    <div class="property-detail">
                        <strong>Built Area:</strong>
                        <span>${builtArea}${builtArea !== '-' ? 'm²' : ''}</span>
                    </div>
                    <div class="property-detail">
                        <strong>Land Area:</strong>
                        <span>${landArea}${landArea !== '-' ? 'm²' : ''}</span>
                    </div>
                </div>
                ${imageUrl ? `<img src="${imageUrl}" alt="Property Image" class="property-image" loading="lazy">` : ''}
            `;
            
            // Add click handler
            card.addEventListener('click', () => {
                // Track property view
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'property_view', {
                        property_id: property.id || 'unknown',
                        page_location: window.location.href
                    });
                }
                
                console.log('👁️ Viewing property:', property.id || title);
            });
            
            return card;
        }

        // Format price with proper formatting
        function formatPrice(price) {
            if (!price || price === null || price === undefined) {
                return 'Price on request';
            }
            
            const numPrice = typeof price === 'number' ? price : parseInt(price);
            
            if (isNaN(numPrice) || numPrice <= 0) {
                return 'Price on request';
            }
            
            return `€${numPrice.toLocaleString()}`;
        }

        // Update filter status display
        function updateFilterStatus(filters, resultCount, totalCount) {
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusText = document.getElementById('filterStatusText');
            
            const hasFilters = Object.keys(filters).some(key => filters[key] && filters[key].trim());
            
            if (hasFilters) {
                const filterDescriptions = [];
                if (filters.location) filterDescriptions.push(`Location: ${filters.location}`);
                if (filters.type) filterDescriptions.push(`Type: ${filters.type}`);
                if (filters.price_min || filters.price_max) {
                    const priceRange = [];
                    if (filters.price_min) priceRange.push(`From €${parseInt(filters.price_min).toLocaleString()}`);
                    if (filters.price_max) priceRange.push(`To €${parseInt(filters.price_max).toLocaleString()}`);
                    filterDescriptions.push(`Price: ${priceRange.join(' - ')}`);
                }
                if (filters.bedrooms) filterDescriptions.push(`Bedrooms: ${filters.bedrooms}+`);
                
                filterStatusText.innerHTML = `
                    <strong>Filtered Results:</strong> ${resultCount} properties found
                    ${totalCount ? ` (out of ${totalCount} total)` : ''}
                    <br><small>Active filters: ${filterDescriptions.join(', ')}</small>
                `;
                
                filterStatus.style.display = 'block';
            } else {
                filterStatus.style.display = 'none';
            }
        }

        // Show no results message
        function showNoResults() {
            const container = document.getElementById('property-results');
            container.innerHTML = `
                <div class="no-results">
                    <h3>No Properties Found</h3>
                    <p>No properties match your current search criteria.</p>
                    <button onclick="clearAllFilters()" class="search-btn">Clear All Filters</button>
                </div>
            `;
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('property-results');
            container.innerHTML = `
                <div class="error-state">
                    <h3>Error Loading Properties</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()" class="search-btn">Try Again</button>
                </div>
            `;
        }

        // Initialize search form
        function initSearchForm() {
            const searchForm = document.getElementById('propertySearchForm');
            
            if (!searchForm) return;
            
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(searchForm);
                const filters = {};
                
                // Get all form values
                if (formData.get('location')) filters.location = formData.get('location');
                if (formData.get('type')) filters.type = formData.get('type');
                if (formData.get('price_min')) filters.price_min = formData.get('price_min');
                if (formData.get('price_max')) filters.price_max = formData.get('price_max');
                if (formData.get('bedrooms')) filters.bedrooms = formData.get('bedrooms');
                
                // Update URL with new filters
                const params = new URLSearchParams(filters);
                const newUrl = `/properties/${params.toString() ? '?' + params.toString() : ''}`;
                window.history.pushState({}, '', newUrl);
                
                // Update page title
                updatePageTitle(filters);
                
                // Load properties with new filters
                loadProperties(filters);
            });
        }

        // Clear all filters
        function clearAllFilters() {
            // Reset form
            document.getElementById('propertySearchForm').reset();
            
            // Update URL to remove parameters
            window.history.pushState({}, '', '/properties/');
            
            // Reset page title
            document.getElementById('pageTitle').textContent = 'Properties';
            document.getElementById('pageSubtitle').textContent = 'Discover exceptional homes in Catalunya\'s most coveted destinations';
            document.title = 'Properties | VERV ONE';
            
            // Load all properties
            loadProperties();
        }

        // Initialize mobile menu
        function initMobileMenu() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const navMenu = document.getElementById('navMenu');
            
            if (mobileMenuToggle && navMenu) {
                mobileMenuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
        }

        // Make functions available globally
        window.clearAllFilters = clearAllFilters;
    </script>
</body>
</html>
