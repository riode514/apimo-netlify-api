// Global variables
let allProperties = [];

// Function to load properties from API
async function loadProperties() {
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error-message');
    const resultsContainer = document.getElementById('results-container');
    
    // Show loading state
    loadingElement.style.display = 'block';
    errorElement.style.display = 'none';
    resultsContainer.innerHTML = '';
    
    try {
        console.log('Fetching properties from API...');
        
        // Use the working endpoint
        const response = await fetch('/.netlify/functions/properties');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.success && data.properties) {
            // Transform Apimo data to frontend format
            allProperties = transformApimoProperties(data.properties);
            displayProperties(allProperties);
            
            console.log(`‚úÖ Loaded ${allProperties.length} properties successfully`);
        } else {
            throw new Error('Invalid response format from API');
        }
        
    } catch (error) {
        console.error('Error loading properties:', error);
        
        // Show error message
        errorElement.style.display = 'block';
        errorElement.innerHTML = `
            <strong>Error al cargar propiedades:</strong><br>
            ${error.message}<br><br>
            <strong>Informaci√≥n de depuraci√≥n:</strong><br>
            ‚Ä¢ API Endpoint: /.netlify/functions/properties<br>
            ‚Ä¢ <a href="/.netlify/functions/properties" target="_blank">Ver respuesta API directa</a><br>
            ‚Ä¢ Cargando datos de ejemplo como respaldo...
        `;
        
        // Load sample data as fallback
        loadSampleData();
        
    } finally {
        loadingElement.style.display = 'none';
    }
}

// Function to transform Apimo API data to frontend format
function transformApimoProperties(apimoProperties) {
    return apimoProperties.map((property, index) => {
        
        // Extract price from different possible fields
        let price = 'Precio a consultar';
        if (property.price) {
            price = `‚Ç¨${property.price.toLocaleString()}`;
        } else if (property.pricing && property.pricing.price) {
            price = `‚Ç¨${property.pricing.price.toLocaleString()}`;
        }
        
        // Extract location from different possible fields
        let location = 'Ubicaci√≥n disponible';
        if (property.location) {
            location = property.location;
        } else if (property.address) {
            location = property.address.city || property.address.area || 'Espa√±a';
        } else if (property.city) {
            location = property.city;
        }
        
        // Extract bedrooms/bathrooms from areas or rooms
        let bedrooms = 'N/A';
        let bathrooms = 'N/A';
        
        if (property.areas) {
            const bedroomArea = property.areas.find(area => 
                area.type === 'bedroom' || area.type === 'room' || area.name?.toLowerCase().includes('dormitorio')
            );
            if (bedroomArea) {
                bedrooms = bedroomArea.count || bedroomArea.number || 'N/A';
            }
            
            const bathroomArea = property.areas.find(area => 
                area.type === 'bathroom' || area.name?.toLowerCase().includes('ba√±o')
            );
            if (bathroomArea) {
                bathrooms = bathroomArea.count || bathroomArea.number || 'N/A';
            }
        }
        
        // Extract surface area
        let size = 'N/A';
        if (property.surface) {
            size = `${property.surface}m¬≤`;
        } else if (property.area) {
            size = `${property.area}m¬≤`;
        } else if (property.areas && property.areas.length > 0) {
            const totalArea = property.areas.reduce((sum, area) => sum + (area.surface || 0), 0);
            if (totalArea > 0) {
                size = `${totalArea}m¬≤`;
            }
        }
        
        // Extract image
        let image = '../assets/images/property-placeholder.jpg';
        if (property.pictures && property.pictures.length > 0) {
            image = property.pictures[0].url || property.pictures[0].picture;
        } else if (property.images && property.images.length > 0) {
            image = property.images[0].url || property.images[0];
        } else if (property.picture) {
            image = property.picture;
        }
        
        return {
            id: property.id || index + 1,
            title: property.title || property.name || 'Propiedad disponible',
            price: price,
            location: location,
            bedrooms: bedrooms,
            bathrooms: bathrooms,
            size: size,
            image: image,
            featured: property.featured || property.is_featured || false,
            // Keep original data for detailed view
            originalData: property
        };
    });
}

// Function to display properties
function displayProperties(properties) {
    const resultsContainer = document.getElementById('results-container');
    
    if (!properties || properties.length === 0) {
        resultsContainer.innerHTML = '<p>No se encontraron propiedades.</p>';
        return;
    }
    
    const propertiesGrid = document.createElement('div');
    propertiesGrid.className = 'properties-grid';
    
    properties.forEach(property => {
        const propertyCard = createPropertyCard(property);
        propertiesGrid.appendChild(propertyCard);
    });
    
    resultsContainer.innerHTML = '';
    resultsContainer.appendChild(propertiesGrid);
    
    // Update results count
    const countElement = document.createElement('div');
    countElement.className = 'results-count';
    countElement.innerHTML = `<p>Se encontraron ${properties.length} propiedades</p>`;
    resultsContainer.insertBefore(countElement, propertiesGrid);
}

// Function to create property card
function createPropertyCard(property) {
    const card = document.createElement('div');
    card.className = 'property-card';
    
    card.innerHTML = `
        <img src="${property.image}" alt="${property.title}" class="property-image" 
             onerror="this.src='../assets/images/property-placeholder.jpg'">
        <div class="property-info">
            <div class="property-price">${property.price}</div>
            <h3 class="property-title">${property.title}</h3>
            <p class="property-location">üìç ${property.location}</p>
            <div class="property-details">
                <span>üõèÔ∏è ${property.bedrooms} hab.</span>
                <span>üöø ${property.bathrooms} ba√±os</span>
                <span>üìê ${property.size}</span>
            </div>
        </div>
    `;
    
    // Add click handler
    card.addEventListener('click', () => {
        // Store property data in sessionStorage for the detail page
        sessionStorage.setItem('selectedProperty', JSON.stringify(property));
        window.location.href = `../single-property/index.html?id=${property.id}`;
    });
    
    return card;
}

// Function to load sample data as fallback
function loadSampleData() {
    console.log('Loading sample data as fallback...');
    
    const sampleProperties = [
        {
            id: 1,
            title: "Villa Moderna en Barcelona",
            price: "‚Ç¨450,000",
            location: "Barcelona, Espa√±a",
            bedrooms: 3,
            bathrooms: 2,
            size: "120m¬≤",
            image: "../assets/images/property-placeholder.jpg"
        },
        {
            id: 2,
            title: "Apartamento Costero en Sitges",
            price: "‚Ç¨320,000",
            location: "Sitges, Espa√±a",
            bedrooms: 2,
            bathrooms: 1,
            size: "85m¬≤",
            image: "../assets/images/property-placeholder.jpg"
        },
        {
            id: 3,
            title: "Casa Hist√≥rica en Costa Brava",
            price: "‚Ç¨580,000",
            location: "Costa Brava, Espa√±a",
            bedrooms: 4,
            bathrooms: 3,
            size: "160m¬≤",
            image: "../assets/images/property-placeholder.jpg"
        }
    ];
    
    allProperties = sampleProperties;
    displayProperties(allProperties);
}

// Load properties when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, fetching properties...');
    loadProperties();
});

// Debug function
async function debugAPI() {
    try {
        const response = await fetch('/.netlify/functions/properties');
        const data = await response.json();
        console.log('üîç DEBUG - Full API Response:', data);
        console.log('üîç DEBUG - Properties count:', data.properties?.length || 0);
        console.log('üîç DEBUG - First property:', data.properties?.[0]);
    } catch (error) {
        console.error('üîç DEBUG - API Error:', error);
    }
}

// Run debug on load
document.addEventListener('DOMContentLoaded', debugAPI);
